# 02_Blake2Generatorä¼ªéšæœºæ•°ç”Ÿæˆå™¨

## ğŸ“‹ æ¦‚è¿°

Blake2Generator æ˜¯ SuperscalarProgram ç”Ÿæˆå™¨çš„æ ¸å¿ƒéšæœºæ•°æºï¼ŒåŸºäº Blake2b å“ˆå¸Œç®—æ³•æä¾›é«˜è´¨é‡çš„ä¼ªéšæœºæ•°æµã€‚å®ƒå°†è¾“å…¥å¯†é’¥è½¬æ¢ä¸ºæºæºä¸æ–­çš„éšæœºå­—èŠ‚ï¼Œä¸ºæŒ‡ä»¤ç”Ÿæˆã€å¯„å­˜å™¨é€‰æ‹©å’Œç«‹å³æ•°ç”Ÿæˆæä¾›ç†µæºã€‚

## ğŸ”¬ Blake2Generator æ¶æ„

### æ ¸å¿ƒæ•°æ®ç»“æ„

```cpp
namespace randomx {
    class Blake2Generator {
    public:
        Blake2Generator(const void* seed, size_t seedSize, int nonce = 0);
        uint8_t getByte();
        uint32_t getUInt32();
    
    private:
        void checkData(const size_t bytesNeeded);
        
        uint8_t data[64];       // 512ä½è¾“å‡ºç¼“å†²åŒº
        size_t dataIndex;       // 64ä½å½“å‰ç´¢å¼•ä½ç½®
    };
}
```

### ä½å®½å¸ƒå±€åˆ†æ

| å­—æ®µå | ç±»å‹ | ä½å®½ | ç”¨é€” | å¯¹é½è¦æ±‚ |
|--------|------|------|------|----------|
| `data[64]` | uint8_tæ•°ç»„ | 512ä½ | å­˜å‚¨Blake2bè¾“å‡º | 64å­—èŠ‚å¯¹é½ |
| `dataIndex` | size_t | 64ä½ | å½“å‰æ¶ˆè´¹ä½ç½® | 8å­—èŠ‚å¯¹é½ |
| å†…éƒ¨Blake2bçŠ¶æ€ | blake2b_state | 512ä½ | å“ˆå¸Œè®¡ç®—çŠ¶æ€ | 16å­—èŠ‚å¯¹é½ |
| **æ€»è®¡** | | **1088ä½** | **136å­—èŠ‚** | **16å­—èŠ‚å¯¹é½** |

## ğŸ”„ åˆå§‹åŒ–è¿‡ç¨‹

### æ„é€ å‡½æ•°ä½å®½æµè½¬

```cpp
Blake2Generator::Blake2Generator(const void* seed, size_t seedSize, int nonce) {
    // æ­¥éª¤1: è¾“å…¥å‚æ•°å¤„ç†
    // seed: 0-480ä½å¯å˜é•¿åº¦å¯†é’¥
    // seedSize: 32ä½é•¿åº¦å€¼  
    // nonce: 32ä½éšæœºåŒ–å€¼
    
    // æ­¥éª¤2: Blake2bå‚æ•°ç»“æ„åˆå§‹åŒ– (512ä½å‚æ•°å—)
    blake2b_param param;
    memset(&param, 0, sizeof(param));
    param.digest_length = 64;           // 8ä½: è¾“å‡ºé•¿åº¦512ä½
    param.key_length = 0;               // 8ä½: æ— å¯†é’¥æ¨¡å¼
    param.fanout = 1;                   // 8ä½: å•çº¿ç¨‹
    param.depth = 1;                    // 8ä½: å•å±‚
    param.leaf_length = 0;              // 32ä½: å¶å­é•¿åº¦
    param.node_offset = 0;              // 64ä½: èŠ‚ç‚¹åç§»
    param.xof_length = 0;               // 64ä½: XOFé•¿åº¦
    param.node_depth = 0;               // 8ä½: èŠ‚ç‚¹æ·±åº¦
    param.inner_length = 0;             // 8ä½: å†…éƒ¨é•¿åº¦
    // æ€»è®¡: 216ä½å‚æ•° + 296ä½ä¿ç•™ = 512ä½å¯¹é½
    
    // æ­¥éª¤3: Blake2bçŠ¶æ€åˆå§‹åŒ– (512ä½çŠ¶æ€)
    blake2b_state state;
    blake2b_init_param(&state, &param); // å°†512ä½å‚æ•°â†’512ä½çŠ¶æ€
    
    // æ­¥éª¤4: è¾“å…¥æ•°æ®å¤„ç†
    blake2b_update(&state, seed, seedSize);     // å¯†é’¥æ•°æ®æ³¨å…¥
    blake2b_update(&state, &nonce, sizeof(int)); // nonceæ³¨å…¥ (32ä½)
    
    // æ­¥éª¤5: é¦–æ¬¡è¾“å‡ºç”Ÿæˆ (512ä½Blake2bçŠ¶æ€ â†’ 512ä½è¾“å‡º)
    blake2b_final(&state, data, 64);    // ç”Ÿæˆ64å­—èŠ‚åˆå§‹éšæœºæ•°æ®
    
    // æ­¥éª¤6: ç´¢å¼•é‡ç½®
    dataIndex = 0;                      // 64ä½ç´¢å¼•å½’é›¶
}
```

### åˆå§‹åŒ–ä½å®½æ˜ å°„å›¾

```mermaid
graph LR
    A[è¾“å…¥å¯†é’¥<br/>0-480ä½] --> B[Blake2bå‚æ•°<br/>512ä½ç»“æ„]
    B --> C[Blake2bçŠ¶æ€<br/>512ä½çŠ¶æ€æœº]
    C --> D[é¦–æ¬¡å“ˆå¸Œ<br/>512ä½è®¡ç®—]
    D --> E[è¾“å‡ºç¼“å†²<br/>512ä½æ•°æ®]
    F[nonce<br/>32ä½] --> C
    E --> G[ç´¢å¼•åˆå§‹åŒ–<br/>64ä½=0]
```

## ğŸ² éšæœºæ•°ç”Ÿæˆæœºåˆ¶

### getByte() æ–¹æ³•è¯¦è§£

```cpp
uint8_t Blake2Generator::getByte() {
    // æ­¥éª¤1: æ•°æ®å¯ç”¨æ€§æ£€æŸ¥ (64ä½ç´¢å¼•æ¯”è¾ƒ)
    checkData(1);                       // ç¡®ä¿è‡³å°‘1å­—èŠ‚å¯ç”¨
    
    // æ­¥éª¤2: å­—èŠ‚æå– (8ä½æ•°æ®è¯»å–)
    return data[dataIndex++];           // è¿”å›8ä½ + 64ä½ç´¢å¼•é€’å¢
}
```

**ä½å®½æ“ä½œåˆ†æ**:
- è¾“å…¥: æ— ç›´æ¥è¾“å…¥
- æ£€æŸ¥: 64ä½ç´¢å¼•ä¸64ä½å¸¸é‡æ¯”è¾ƒ
- è¾“å‡º: 8ä½éšæœºå­—èŠ‚
- å‰¯ä½œç”¨: 64ä½ç´¢å¼•é€’å¢

### getUInt32() æ–¹æ³•è¯¦è§£

```cpp
uint32_t Blake2Generator::getUInt32() {
    // æ­¥éª¤1: æ•°æ®å……è¶³æ€§æ£€æŸ¥ (64ä½ç´¢å¼•æ¯”è¾ƒ)
    checkData(4);                       // ç¡®ä¿è‡³å°‘4å­—èŠ‚å¯ç”¨
    
    // æ­¥éª¤2: 32ä½æ•´æ•°ç»„è£… (å°ç«¯åº)
    uint32_t result;
    result  = (uint32_t)data[dataIndex++] << 0;   // ä½8ä½
    result |= (uint32_t)data[dataIndex++] << 8;   // æ¬¡ä½8ä½
    result |= (uint32_t)data[dataIndex++] << 16;  // æ¬¡é«˜8ä½
    result |= (uint32_t)data[dataIndex++] << 24;  // é«˜8ä½
    
    return result;                      // è¿”å›32ä½æ•´æ•°
}
```

**ä½å®½æ“ä½œåˆ†æ**:
- è¾“å…¥: æ— ç›´æ¥è¾“å…¥
- æ£€æŸ¥: 64ä½ç´¢å¼•ä¸64ä½å¸¸é‡æ¯”è¾ƒ
- å¤„ç†: 4Ã—8ä½â†’32ä½ä½ç§»ç»„è£…
- è¾“å‡º: 32ä½éšæœºæ•´æ•°
- å‰¯ä½œç”¨: 64ä½ç´¢å¼•é€’å¢4

### checkData() ç¼“å†²åŒºåˆ·æ–°æœºåˆ¶

```cpp
void Blake2Generator::checkData(const size_t bytesNeeded) {
    // æ­¥éª¤1: å‰©ä½™æ•°æ®é‡è®¡ç®— (64ä½ç®—æœ¯)
    size_t remaining = 64 - dataIndex;  // 64ä½å‡æ³•
    
    // æ­¥éª¤2: æ•°æ®å……è¶³æ€§åˆ¤æ–­
    if (remaining < bytesNeeded) {      // 64ä½æ¯”è¾ƒ
        
        // æ­¥éª¤3: Blake2bçŠ¶æ€é‡æ–°åˆå§‹åŒ– (512ä½çŠ¶æ€é‡ç½®)
        blake2b_state state;
        blake2b_init(&state, 64);       // æ ‡å‡†64å­—èŠ‚è¾“å‡º
        
        // æ­¥éª¤4: å½“å‰æ•°æ®ä½œä¸ºç§å­ (512ä½æ•°æ®â†’512ä½çŠ¶æ€)
        blake2b_update(&state, data, 64); // å°†å½“å‰64å­—èŠ‚æ³¨å…¥
        
        // æ­¥éª¤5: æ–°éšæœºæ•°æ®ç”Ÿæˆ (512ä½çŠ¶æ€â†’512ä½è¾“å‡º)
        blake2b_final(&state, data, 64); // ç”Ÿæˆæ–°çš„64å­—èŠ‚
        
        // æ­¥éª¤6: ç´¢å¼•é‡ç½® (64ä½èµ‹å€¼)
        dataIndex = 0;                  // é‡æ–°å¼€å§‹æ¶ˆè´¹
    }
}
```

**ç¼“å†²åŒºåˆ·æ–°ä½å®½æµè½¬**:

```mermaid
graph TD
    A[æ£€æŸ¥è¯·æ±‚<br/>64ä½æ¯”è¾ƒ] --> B{æ•°æ®å……è¶³?}
    B -->|æ˜¯| C[ç›´æ¥è¿”å›<br/>æ— æ“ä½œ]
    B -->|å¦| D[Blake2båˆå§‹åŒ–<br/>512ä½çŠ¶æ€]
    D --> E[å½“å‰æ•°æ®æ³¨å…¥<br/>512ä½â†’512ä½]
    E --> F[æ–°æ•°æ®ç”Ÿæˆ<br/>512ä½â†’512ä½]
    F --> G[ç´¢å¼•é‡ç½®<br/>64ä½=0]
```

## ğŸ“Š æ€§èƒ½ä¸ä½å®½åˆ†æ

### å•æ¬¡æ“ä½œä½å®½æˆæœ¬

| æ“ä½œç±»å‹ | è¾“å…¥ä½å®½ | è¾“å‡ºä½å®½ | å†…éƒ¨è®¡ç®—ä½å®½ | æ—¶é—´å¤æ‚åº¦ |
|----------|----------|----------|-------------|------------|
| **æ„é€ å‡½æ•°** | 0-512ä½ | 576ä½çŠ¶æ€ | 512ä½Blake2b | O(å¯†é’¥é•¿åº¦) |
| **getByte()** | 0ä½ | 8ä½ | 64ä½æ¯”è¾ƒ | O(1) |
| **getUInt32()** | 0ä½ | 32ä½ | 64ä½æ¯”è¾ƒ+32ä½ç»„è£… | O(1) |
| **checkData()** | 64ä½ | 576ä½çŠ¶æ€ | 512ä½Blake2b | O(1)å‡æ‘Š |

### ç¼“å†²åŒºç”Ÿå‘½å‘¨æœŸåˆ†æ

```cpp
// 64å­—èŠ‚ç¼“å†²åŒºçš„æ¶ˆè´¹æ¨¡å¼ç¤ºä¾‹
Blake2Generator gen(key, keySize);

// é˜¶æ®µ1: åˆå§‹ç¼“å†²åŒº (64å­—èŠ‚å¯ç”¨)
for (int i = 0; i < 64; i++) {
    uint8_t byte = gen.getByte();    // 8ä½è¾“å‡º, dataIndex++
}
// dataIndex = 64, ç¼“å†²åŒºè€—å°½

// é˜¶æ®µ2: é¦–æ¬¡åˆ·æ–°è§¦å‘ (checkDataå†…éƒ¨)
uint8_t nextByte = gen.getByte();    // è§¦å‘512ä½Blake2bè®¡ç®—
// dataIndex = 1, æ–°çš„64å­—èŠ‚å¯ç”¨

// é˜¶æ®µ3: 32ä½æ•´æ•°æ¶ˆè´¹æ¨¡å¼
for (int i = 0; i < 16; i++) {       // 16Ã—4 = 64å­—èŠ‚
    uint32_t value = gen.getUInt32(); // 32ä½è¾“å‡º, dataIndex += 4
}
// dataIndex = 64, å†æ¬¡è§¦å‘åˆ·æ–°
```

### ä½å®½æ•ˆç‡åˆ†æ

| æ¶ˆè´¹æ¨¡å¼ | ç¼“å†²åŒºåˆ©ç”¨ç‡ | å¹³å‡ä½å®½æˆæœ¬ | åˆ·æ–°é¢‘ç‡ |
|----------|-------------|-------------|----------|
| **çº¯å­—èŠ‚æ¨¡å¼** | 100% | 8ä½/æ“ä½œ | æ¯64æ¬¡æ“ä½œ |
| **çº¯32ä½æ¨¡å¼** | 100% | 32ä½/æ“ä½œ | æ¯16æ¬¡æ“ä½œ |
| **æ··åˆæ¨¡å¼** | å–å†³äºæ¯”ä¾‹ | 8-32ä½/æ“ä½œ | ä¸è§„å¾‹ |

## ğŸ¯ åœ¨SuperscalarProgramä¸­çš„ä½¿ç”¨æ¨¡å¼

### å…¸å‹è°ƒç”¨åºåˆ—ä½å®½åˆ†æ

```cpp
void generateSuperscalar(SuperscalarProgram& prog, Blake2Generator& gen) {
    // è§£ç å™¨é€‰æ‹©: 8ä½éšæœºæ•° â†’ è§£ç å™¨é…ç½®
    uint8_t decoderChoice = gen.getByte() & 0x3F;  // 8ä½â†’6ä½æ©ç 
    
    // æŒ‡ä»¤ç±»å‹é€‰æ‹©: 8ä½éšæœºæ•° â†’ æŒ‡ä»¤ç±»å‹
    uint8_t instrChoice = gen.getByte() & 0x0F;    // 8ä½â†’4ä½æ©ç 
    
    // ç«‹å³æ•°ç”Ÿæˆ: 32ä½éšæœºæ•° â†’ æŒ‡ä»¤ç«‹å³æ•°
    uint32_t immediate = gen.getUInt32();          // å®Œæ•´32ä½
    
    // å¯„å­˜å™¨é€‰æ‹©: 8ä½éšæœºæ•° â†’ 3ä½å¯„å­˜å™¨ID
    uint8_t regChoice = gen.getByte() % 8;         // 8ä½â†’3ä½æ¨¡è¿ç®—
    
    // ä¿®é¥°ç¬¦ç”Ÿæˆ: 8ä½éšæœºæ•° â†’ ç§»ä½é‡/æ©ç 
    uint8_t modifier = gen.getByte() & 0x3F;       // 8ä½â†’6ä½æ©ç 
}
```

### ç”Ÿæˆä¸€ä¸ªå®Œæ•´ç¨‹åºçš„ä½å®½æ¶ˆè´¹

```cpp
// ä¼°ç®—å•ç¨‹åºç”Ÿæˆçš„éšæœºæ•°æ¶ˆè´¹é‡
const int ESTIMATED_INSTRUCTIONS = 450;
const int DECODER_CYCLES = 170;

// ä½å®½æ¶ˆè´¹ä¼°ç®—:
// 1. è§£ç å™¨é€‰æ‹©: 170å‘¨æœŸ Ã— 8ä½ = 1,360ä½
// 2. æŒ‡ä»¤ç±»å‹: 450æ¡ Ã— 8ä½ = 3,600ä½  
// 3. ç«‹å³æ•°: ~300æ¡éœ€è¦ Ã— 32ä½ = 9,600ä½
// 4. å¯„å­˜å™¨é€‰æ‹©: 450æ¡ Ã— 2å¯„å­˜å™¨ Ã— 8ä½ = 7,200ä½
// 5. ä¿®é¥°ç¬¦: ~150æ¡éœ€è¦ Ã— 8ä½ = 1,200ä½
// æ€»è®¡: ~22,960ä½ â‰ˆ 2.87KBéšæœºæ•°æ®

// ç¼“å†²åŒºåˆ·æ–°æ¬¡æ•°: 2,870å­—èŠ‚ Ã· 64å­—èŠ‚ â‰ˆ 45æ¬¡Blake2bè®¡ç®—
```

## ğŸ”’ å¯†ç å­¦å®‰å…¨æ€§åˆ†æ

### Blake2bç®—æ³•ä½å®½å®‰å…¨æ€§

| å®‰å…¨å±æ€§ | ä½å®½å¼ºåº¦ | è¯´æ˜ |
|----------|----------|------|
| **æŠ—ç¢°æ’æ€§** | 256ä½ | åŠè¾“å‡ºé•¿åº¦æŠ—ç¢°æ’ |
| **æŠ—åŸåƒæ”»å‡»** | 512ä½ | å®Œæ•´è¾“å‡ºé•¿åº¦ |
| **æŠ—ç¬¬äºŒåŸåƒ** | 512ä½ | å®Œæ•´è¾“å‡ºé•¿åº¦ |
| **ä¼ªéšæœºæ€§** | 512ä½ | è¾“å‡ºåˆ†å¸ƒå‡åŒ€æ€§ |

### ç†µæºè´¨é‡ä¿è¯

```cpp
// ç†µé“¾ä¼ æ’­åˆ†æ
è¾“å…¥å¯†é’¥(0-480ä½ç†µ) 
    â†’ Blake2bå“ˆå¸Œ(512ä½å®‰å…¨å¼ºåº¦)
    â†’ 64å­—èŠ‚è¾“å‡º(512ä½ä¼ªéšæœº)
    â†’ è¿ç»­åˆ·æ–°(512ä½â†’512ä½ä¼ æ’­)
    â†’ æŒ‡ä»¤ç”Ÿæˆ(æ¯8/32ä½é«˜è´¨é‡éšæœº)
```

**ç†µè´¨é‡ä¿è¯**:
- è¾“å…¥ç†µé€šè¿‡Blake2bå……åˆ†æ‰©æ•£åˆ°512ä½è¾“å‡º
- æ¯æ¬¡åˆ·æ–°ç»´æŒ512ä½çš„ä¼ªéšæœºå¼ºåº¦  
- è¾“å‡ºä½æµé€šè¿‡å¯†ç å­¦æµ‹è¯•(NIST SP 800-22)
- é•¿å‘¨æœŸæ€§ä¿è¯(å‘¨æœŸé•¿åº¦ > 2^128)

## ğŸš€ ä¼˜åŒ–å®ç°è¦ç‚¹

### 1. ç¼“å­˜å¯¹é½ä¼˜åŒ–

```cpp
// 64å­—èŠ‚ç¼“å†²åŒºçš„ç¼“å­˜è¡Œå¯¹é½
alignas(64) uint8_t data[64];  // CPUç¼“å­˜è¡Œå¯¹é½
```

**ä½å®½ä¼˜åŒ–æ•ˆæœ**:
- å•æ¬¡ç¼“å­˜è¡ŒåŠ è½½è·å–å®Œæ•´64å­—èŠ‚
- å‡å°‘å†…å­˜è®¿é—®å»¶è¿Ÿ
- æé«˜ä½å®½æ“ä½œçš„å¹¶è¡Œåº¦

### 2. ä½è¿ç®—ä¼˜åŒ–

```cpp
// é«˜æ•ˆçš„32ä½ç»„è£… (åˆ©ç”¨CPUçš„å°ç«¯åºç‰¹æ€§)
uint32_t getUInt32Fast() {
    checkData(4);
    uint32_t result = *(uint32_t*)(data + dataIndex);  // å•æ¬¡32ä½è¯»å–
    dataIndex += 4;
    return result;
}
```

### 3. æ‰¹é‡ç”Ÿæˆä¼˜åŒ–

```cpp
// æ‰¹é‡ç”Ÿæˆå¤šä¸ª32ä½å€¼ (å‡å°‘å‡½æ•°è°ƒç”¨å¼€é”€)
void getMultipleUInt32(uint32_t* output, size_t count) {
    checkData(count * 4);
    for (size_t i = 0; i < count; i++) {
        output[i] = *(uint32_t*)(data + dataIndex);
        dataIndex += 4;
    }
}
```

## ğŸ“ˆ æ€§èƒ½åŸºå‡†æµ‹è¯•

### ç†è®ºæ€§èƒ½åˆ†æ

| æ“ä½œ | æ¯ç§’æ“ä½œæ•° | æ¯ç§’è¾“å‡ºä½å®½ | ç›¸å¯¹å¼€é”€ |
|------|------------|-------------|----------|
| **getByte()** | ~100M/s | 800Mbps | åŸºå‡† |
| **getUInt32()** | ~80M/s | 2.56Gbps | 1.25Ã— |
| **Blake2båˆ·æ–°** | ~2M/s | - | 50Ã— |

### å®é™…ä½¿ç”¨åœºæ™¯æ€§èƒ½

```cpp
// ç”Ÿæˆ8ä¸ªSuperscalarProgramçš„éšæœºæ•°å¼€é”€
const double BYTES_PER_PROGRAM = 2870;
const double TOTAL_BYTES = 8 * BYTES_PER_PROGRAM = 22,960;
const double BLAKE2B_CYCLES = TOTAL_BYTES / 64 = 358;

// åœ¨ç°ä»£CPUä¸Šçš„æ—¶é—´ä¼°ç®— (3GHz):
// Blake2bè®¡ç®—: 358æ¬¡ Ã— 1000å‘¨æœŸ = 358,000å‘¨æœŸ â‰ˆ 0.12ms
// å…¶ä»–æ“ä½œ: ~50,000å‘¨æœŸ â‰ˆ 0.017ms  
// æ€»æ—¶é—´: ~0.14ms/8ä¸ªç¨‹åº
```

---

**ä¸‹ä¸€èŠ‚é¢„å‘Š**: [03_CPUæ¨¡æ‹Ÿå™¨ä¸æŒ‡ä»¤è°ƒåº¦.md](./03_CPUæ¨¡æ‹Ÿå™¨ä¸æŒ‡ä»¤è°ƒåº¦.md) - è¯¦ç»†åˆ†æå‚è€ƒCPUçš„æ¨¡æ‹Ÿå®ç°å’Œæ‰§è¡Œç«¯å£è°ƒåº¦ç®—æ³•ã€‚ 